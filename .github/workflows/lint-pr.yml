name: "Lint PR"

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize
  schedule:
    - cron: "0 8 * * *"

jobs:
  check-yaml-lint:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{github.event.pull_request.head.repo.full_name}}

      - name: Install Yaml lint
        run: |
          pip install yamllint

      - name: install mustache
        run: |
          npm i -g mustache 
          echo "{}" > test.json
      
      - name: check yaml lint
        run: |
          TRAGET=origin/${{ github.event.pull_request.base.ref }}
          echo '-------------- step 0', $TRAGET
          CHANGED=$(git diff --diff-filter=MARC $TRAGET...HEAD --name-only -- templates/scenarios)
          echo '-------------- step1' $CHANGED
          YMLTPL=$(echo $CHANGED | grep -E '.yml.tpl$')
          echo '-------------- step2.1' $YMLTPL
          if [ ! -z "$YMLTPL" ]
          then
              for obj in "$YMLTPL"
              do
                mustache test.json $obj | yamllint -
              done
          fi
